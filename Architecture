 

# ğŸ¯ ShieldX Tenant Platform

**Internal Developer Platform cho Multi-Tenant Kubernetes (Security-First)**

## 1. Problem Statement (BÃ i toÃ¡n gá»‘c)

* CÃ´ng ty cÃ³ **100 Devs / 10 Teams**
* Má»—i team cáº§n:

  * Namespace riÃªng
  * RBAC Ä‘Ãºng ngÆ°á»i
  * Network isolation
  * ResourceQuota theo tier
  * Enforce **signed images**
* LÃ m thá»§ cÃ´ng = **khÃ´ng scale**, **dá»… sai**, **khÃ´ng audit Ä‘Æ°á»£c**

ğŸ‘‰ **Má»¥c tiÃªu:**
Dev **khÃ´ng cáº§n hiá»ƒu Kubernetes**.
Dev chá»‰ cáº§n:

* `shieldctl create tenant ...`
* hoáº·c commit **1 YAML duy nháº¥t**

Platform sáº½ **tá»± Ä‘á»™ng sinh toÃ n bá»™ háº¡ táº§ng an toÃ n**.

---

## 2. High-Level Architecture (Big Picture)

![Image](https://miro.medium.com/v2/resize%3Afit%3A1400/1%2AcHa9nQRozvdG0OGsUKldhg.png)

![Image](https://developers.redhat.com/sites/default/files/styles/article_floated/public/operator-reconciliation-kube-only.png?itok=ZLMeudHd)

![Image](https://kubesphere.io/images/docs/v3.3/access-control-and-account-management/multi-tanancy-in-kubesphere/multi-tenancy-architecture.png)

![Image](https://i1.wp.com/www.learnsteps.com/wp-content/uploads/2020/02/kubearc-1.png?fit=1800%2C1321\&ssl=1)

### Luá»“ng tá»•ng quÃ¡t

```
Dev / CI
   |
   | shieldctl create tenant
   v
Tenant CRD (Source of Truth)
   |
   v
Tenant Controller (Reconcile Loop)
   |
   +--> Namespace
   +--> RBAC
   +--> NetworkPolicy
   +--> ResourceQuota
   +--> Security Labels / Image Policy
```

> **Tenant CRD = Contract**
>
> Controller = **Automation + Governance + Self-Healing**

---

## 3. Core Abstraction â€“ Tenant CRD (THE HEART)

### ğŸ¯ NguyÃªn lÃ½ thiáº¿t káº¿

* **áº¨n complexity** cá»§a K8s
* **Declarative**
* **Opinionated Security by Default**

### Tenant API

```yaml
apiVersion: platform.shieldx.io/v1alpha1
kind: Tenant
metadata:
  name: payment-team
spec:
  owners:
    - alice@company.com
    - bob@company.com

  tier: Gold        # Gold | Silver | Bronze
  isolation: Strict # Strict | Shared
```

### Ã nghÄ©a tá»«ng field (WHY, khÃ´ng chá»‰ WHAT)

| Field       | Ã nghÄ©a                               |
| ----------- | ------------------------------------- |
| `owners`    | Nguá»“n dá»¯ liá»‡u duy nháº¥t cho RBAC       |
| `tier`      | Policy tÃ i nguyÃªn (Quota, LimitRange) |
| `isolation` | Policy máº¡ng (Zero-Trust hay Shared)   |

ğŸ‘‰ **Tenant = Business Object**, khÃ´ng pháº£i K8s Object

---

## 4. The Brain â€“ Tenant Controller (Advanced Reconciliation)

### 4.1 Reconciliation Strategy (Cá»T LÃ•I)

> **Tenant CR = Desired State**
> **Cluster = Observed State**

Controller pháº£i Ä‘áº£m báº£o:

> â Cluster state **luÃ´n** converge vá» Tenant spec â

---

### 4.2 Child Resources Ä‘Æ°á»£c quáº£n lÃ½

| Resource      | TÃªn chuáº©n                            |
| ------------- | ------------------------------------ |
| Namespace     | `tenant-<name>`                      |
| RoleBinding   | `tenant-admins`                      |
| NetworkPolicy | `default-deny`                       |
| ResourceQuota | `tier-<tier>`                        |
| Labels        | `security.shieldx.io/policy=enforce` |

---

### 4.3 Reconcile Flow (Pseudo-logic)

```go
func (r *TenantReconciler) Reconcile(ctx context.Context, req ctrl.Request) {

  tenant := getTenant(req)

  // 1. Namespace
  ensureNamespace(tenant)

  // 2. RBAC
  ensureRoleBinding(tenant.spec.owners)

  // 3. Network Isolation
  if tenant.spec.isolation == "Strict" {
    ensureDenyAllNetworkPolicy()
  }

  // 4. Resource Governance
  ensureQuotaByTier(tenant.spec.tier)

  // 5. Security Hook
  ensureSecurityLabels()
}
```

> âš ï¸ **KhÃ´ng cÃ³ step nÃ o â€œoptionalâ€**
> Secure-by-default lÃ  báº¯t buá»™c.

---

## 5. Self-Healing & Ownership (CHá»– Ä‚N TIá»€N)

### 5.1 OwnerReference â€“ Automatic Garbage Collection

```go
controllerutil.SetControllerReference(tenant, namespace, r.Scheme)
```

**Há»‡ quáº£:**

* XÃ³a Tenant â†’ Namespace + má»i thá»© bÃªn trong **tá»± bay**
* Audit trail rÃµ rÃ ng

---

### 5.2 Drift Detection (CÃ¢u há»i â€œTriá»‡u Ä‘Ã´â€)

> â“ Náº¿u hacker `kubectl edit networkpolicy` thÃ¬ sao?

### âœ… CÃ¢u tráº£ lá»i Ä‘Ãºng (Controller Pattern)

```go
ctrl.NewControllerManagedBy(mgr).
  For(&platformv1.Tenant{}).
  Owns(&corev1.Namespace{}).
  Owns(&netv1.NetworkPolicy{}).
  Owns(&rbacv1.RoleBinding{}).
  Complete(r)
```

#### Äiá»u gÃ¬ xáº£y ra?

* NetworkPolicy bá»‹ sá»­a â†’ **event**
* Controller **bá»‹ Ä‘Ã¡nh thá»©c**
* Reconcile láº¡i tá»« Tenant spec
* Policy bá»‹ **revert ngay láº­p tá»©c**

ğŸ”¥ ÄÃ¢y chÃ­nh lÃ :

> **Policy-as-Code + Continuous Enforcement**

---

## 6. Isolation & Governance (Security Layer)

### 6.1 Network Isolation â€“ Zero Trust by Default

```yaml
kind: NetworkPolicy
spec:
  podSelector: {}
  policyTypes: [Ingress, Egress]
```

* KhÃ´ng ingress
* KhÃ´ng egress
* Chá»‰ cho phÃ©p ná»™i bá»™ namespace

---

### 6.2 Image Security â€“ Supply Chain Enforcement

Controller **khÃ´ng verify image**
Controller chá»‰ **gáº¯n label**

```yaml
metadata:
  labels:
    security.shieldx.io/policy: enforce
```

â¡ Webhook ImagePolicy (báº¡n Ä‘Ã£ viáº¿t trÆ°á»›c Ä‘Ã³) tá»± Ä‘á»™ng kÃ­ch hoáº¡t

> ğŸ¯ **Separation of Concerns**
> Controller = Governance
> Webhook = Enforcement

---

## 7. Developer Experience â€“ shieldctl (CLI)

### 7.1 UX Goal

* Dev **khÃ´ng tháº¥y YAML**
* Dev **khÃ´ng cáº§n quyá»n cluster-admin**
* Feedback **real-time, dá»… hiá»ƒu**

### CLI Command

```bash
shieldctl create tenant \
  --name payment-team \
  --tier gold \
  --users alice,bob
```

### CLI Flow

```
shieldctl
  |
  +--> Validate input
  +--> Create Tenant CR via API
  +--> Watch Tenant.status
  +--> Render progress (spinner)
```

---

### 7.2 Tenant Status (Bonus â€“ ráº¥t Ä‘Ã¡ng lÃ m)

```yaml
status:
  phase: Ready
  namespace: tenant-payment-team
  conditions:
    - type: NetworkPolicyReady
      status: "True"
```

CLI hiá»ƒn thá»‹:

```
âœ” Namespace created
âœ” RBAC configured
âœ” Network isolation enabled
âœ” Image security enforced

Tenant payment-team is READY ğŸš€
```

---

## 8. Roadmap triá»ƒn khai (Expert Mode)

### ğŸ§  Sprint 1 â€“ Abstraction & Provisioning

**Focus:** Controller fundamentals

* Tenant CRD
* Namespace lifecycle
* OwnerReference
* Self-healing

ğŸ¯ Outcome: **Platform tá»± â€œÄ‘áº»â€ háº¡ táº§ng**

---

### ğŸ” Sprint 2 â€“ Isolation & Governance

**Focus:** Security by default

* NetworkPolicy strict
* ResourceQuota theo tier
* Security labels integration

ğŸ¯ Outcome: **Zero-Trust Multi-Tenant Cluster**

---

### ğŸ§‘â€ğŸ’» Sprint 3 â€“ Developer Experience

**Focus:** Adoption

* CLI shieldctl
* Status & UX
* Validation

ğŸ¯ Outcome: **Dev yÃªu platform, khÃ´ng bypass**

---

## 9. VÃ¬ sao Project nÃ y â€œÄ‘Ã¡ng tiá»nâ€ ğŸš€

Báº¡n **khÃ´ng** Ä‘ang:

* Deploy app
* Viáº¿t YAML

Báº¡n **Ä‘ang**:

* Thiáº¿t káº¿ **Platform Abstraction**
* Ãp dá»¥ng **Controller Pattern Ä‘Ãºng chuáº©n**
* Giáº£i bÃ i toÃ¡n **Scale + Security + Governance**
* XÃ¢y **Internal Developer Platform thá»±c thá»¥**

ğŸ‘‰ ÄÃ¢y lÃ  level:

> **Senior / Staff Platform Engineer**
> **DevSecOps Architect**
> **IDP Builder**

---

 